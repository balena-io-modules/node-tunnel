// Generated by CoffeeScript 1.9.3
(function() {
  var MiddlewareHandler, Promise, basicAuth, basicAuthParser, connectSocket, createTunnel, http, net, url;

  http = require('http');

  net = require('net');

  url = require('url');

  Promise = require('bluebird');

  basicAuthParser = require('basic-auth-parser');

  MiddlewareHandler = require('middleware-handler');

  MiddlewareHandler.prototype = Promise.promisifyAll(MiddlewareHandler.prototype);

  connectSocket = function(cltSocket, hostname, port, head) {
    var srvSocket;
    srvSocket = net.connect(port, hostname, function() {
      cltSocket.write('HTTP/1.0 200 Connection Established\r\nProxy-agent: Resin-VPN\r\n\r\n');
      srvSocket.write(head);
      srvSocket.pipe(cltSocket);
      return cltSocket.pipe(srvSocket);
    });
    return new Promise(function(resolve, reject) {
      srvSocket.on('error', reject);
      return srvSocket.on('end', resolve);
    })["finally"](function(e) {
      return srvSocket.end();
    });
  };

  exports.createTunnel = createTunnel = function() {
    var middleware, server, tunnel;
    middleware = new MiddlewareHandler();
    server = http.createServer(function(req, res) {
      res.writeHead(405, {
        'Content-Type': 'text/plain'
      });
      return res.end('Method not allowed');
    });
    server.on('connect', function(req, cltSocket, head) {
      return middleware.handleAsync([req, cltSocket, head]).then(function() {
        var srvUrl;
        srvUrl = url.parse("http://" + req.url);
        return connectSocket(cltSocket, srvUrl.hostname, srvUrl.port, head);
      })["catch"](function(err) {
        return cltSocket.end();
      });
    });
    tunnel = {
      use: middleware.use.bind(middleware),
      listen: server.listen.bind(server)
    };
    return tunnel;
  };

  exports.basicAuth = basicAuth = function(req, cltSocket, head, next) {
    if (req.headers['proxy-authorization'] != null) {
      req.auth = basicAuthParser(req.headers['proxy-authorization']);
    }
    return next();
  };

}).call(this);
